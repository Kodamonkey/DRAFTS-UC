# ๐ Relaciones y Dependencias de la Carpeta `drafts/`

## ๐ **Diagrama de Arquitectura del Pipeline**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           ๐ ENTRADA PRINCIPAL                              โ
โ                              main.py                                        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ๐ PIPELINE PRINCIPAL                                โ
โ                           pipeline.py                                       โ
โ  โข Carga modelos de detecciรณn y clasificaciรณn                              โ
โ  โข Orquesta el procesamiento de archivos                                   โ
โ  โข Maneja chunks y memoria                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    โ๏ธ CONFIGURACIรN Y UTILIDADES                            โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โ  โ   config.py โ  โauto_slice_  โ  โslice_len_   โ  โsummary_     โ        โ
โ  โ             โ  โlen.py       โ  โutils.py     โ  โutils.py     โ        โ
โ  โโข Parรกmetros โ  โโข Cรกlculo    โ  โโข Gestiรณn    โ  โโข Reportes   โ        โ
โ  โโข Switches   โ  โ  automรกtico โ  โ  dinรกmica   โ  โโข Logs       โ        โ
โ  โโข Modelos    โ  โ  de SLICE_  โ  โ  de SLICE_  โ  โโข Resรบmenes  โ        โ
โ  โโข Rutas      โ  โ  LEN        โ  โ  LEN        โ  โ             โ        โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ๐ ENTRADA/SALIDA (I/O)                              โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โ  โ     io.py   โ  โfilterbank_  โ  โ   io_utils  โ  โcandidate_   โ        โ
โ  โ             โ  โio.py        โ  โ.py          โ  โutils.py     โ        โ
โ  โโข Archivos   โ  โโข Archivos   โ  โโข Carga y    โ  โโข Gestiรณn    โ        โ
โ  โ  FITS       โ  โ  FIL        โ  โ  preproces. โ  โ  de CSV     โ        โ
โ  โโข Metadatos  โ  โโข Metadatos  โ  โโข Datos      โ  โโข Headers    โ        โ
โ  โโข Parรกmetros โ  โโข Streaming  โ  โ  unificados โ  โโข Append     โ        โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ PREPROCESAMIENTO                                      โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โ  โpreprocessingโ  โdedispersion โ  โdynamic_dm_  โ  โastro_       โ        โ
โ  โ.py          โ  โ.py          โ  โrange.py     โ  โconversions  โ        โ
โ  โโข Downsample โ  โโข Dedispersiรณnโ  โโข Rangos DM  โ  โ.py          โ        โ
โ  โโข Normaliz.  โ  โโข GPU/CPU    โ  โ  dinรกmicos  โ  โโข Conversiรณn โ        โ
โ  โโข Filtros    โ  โโข Patches    โ  โโข Zoom auto  โ  โ  pixelโDM   โ        โ
โ  โ             โ  โโข Bloques    โ  โโข Visualiz.  โ  โโข Tiempo     โ        โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ฏ DETECCIรN Y CLASIFICACIรN                             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โ  โpipeline_    โ  โ   utils.py  โ  โ  metrics.py โ  โcandidate.py โ        โ
โ  โutils.py     โ  โ             โ  โ             โ  โ             โ        โ
โ  โโข Procesa    โ  โโข Detecciรณn  โ  โโข Cรกlculo    โ  โโข Estructura โ        โ
โ  โ  bandas     โ  โ  CenterNet  โ  โ  SNR        โ  โ  de datos   โ        โ
โ  โโข Procesa    โ  โโข Clasific.  โ  โโข Mรฉtricas   โ  โโข Candidatos โ        โ
โ  โ  slices     โ  โ  ResNet     โ  โโข Estadรญsticasโ  โโข CSV rows   โ        โ
โ  โโข Gestiรณn    โ  โโข Patches    โ  โ             โ  โ             โ        โ
โ  โ  candidatos โ  โ             โ  โ             โ  โ             โ        โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ ANรLISIS Y SNR                                        โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โ  โ   snr_utils โ  โconsistency_ โ  โ             โ  โ             โ        โ
โ  โ   .py       โ  โfixes.py     โ  โ             โ  โ             โ        โ
โ  โโข Cรกlculo    โ  โโข Gestor de  โ  โ             โ  โ             โ        โ
โ  โ  SNR        โ  โ  consistenciaโ  โ             โ  โ             โ        โ
โ  โโข Perfiles   โ  โโข Unificaciรณnโ  โ             โ  โ             โ        โ
โ  โโข Picos      โ  โ  DM/SNR     โ  โ             โ  โ             โ        โ
โ  โโข Regiones   โ  โโข Reportes   โ  โ             โ  โ             โ        โ
โ  โโข Inyecciรณn  โ  โโข Debugging  โ  โ             โ  โ             โ        โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐จ VISUALIZACIรN                                         โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โ  โvisualizationโ  โimage_utils  โ  โplot_manager โ  โ             โ        โ
โ  โ.py          โ  โ.py          โ  โ.py          โ  โ             โ        โ
โ  โโข Composite  โ  โโข Preproces. โ  โโข Orquesta   โ  โ             โ        โ
โ  โ  plots      โ  โ  imรกgenes   โ  โ  todos los  โ  โ             โ        โ
โ  โโข Waterfalls โ  โโข Postproces.โ  โ  plots      โ  โ             โ        โ
โ  โโข Patches    โ  โโข DM dinรกmicoโ  โโข Gestiรณn    โ  โ             โ        โ
โ  โโข SNR plots  โ  โโข Detecciรณn  โ  โ  de memoria โ  โ             โ        โ
โ  โโข Rangos     โ  โ  plots      โ  โโข Optimiz.   โ  โ             โ        โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ        โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ๐ค SALIDA DE RESULTADOS                              โ
โ                                                                             โ
โ  โข Archivos CSV con candidatos detectados                                  โ
โ  โข Imรกgenes de detecciรณn (composite, patches, waterfalls)                  โ
โ  โข Reportes de consistencia y debugging                                    โ
โ  โข Logs de procesamiento                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ **Flujo de Datos Detallado**

### **1. Inicializaciรณn (`pipeline.py`)**

```python
# Carga modelos
det_model = _load_detection_model()      # CenterNet
cls_model = _load_class_model()          # ResNet18

# Configuraciรณn
config.FREQ, config.TIME_RESO, etc.     # Desde archivo FITS/FIL
```

### **2. Procesamiento de Archivos**

```python
# Para cada archivo:
for fits_path in data_files:
    # Carga metadatos
    get_obparams(fits_path)              # io.py / filterbank_io.py

    # Carga datos
    data = load_and_preprocess_data()    # io_utils.py

    # Procesa en chunks
    _process_file_chunked()              # pipeline.py
```

### **3. Procesamiento de Chunks**

```python
# Para cada chunk:
for chunk_idx, (block, metadata) in enumerate(stream):
    # Dedispersiรณn
    dm_time = d_dm_time_g(block)         # dedispersion.py

    # Procesa slices
    for j in range(time_slices):
        process_slice()                  # pipeline_utils.py
```

### **4. Procesamiento de Slices**

```python
# Para cada slice:
for band_idx, band_config in band_configs:
    # Procesa banda
    process_band()                       # pipeline_utils.py

    # Detecciรณn
    top_conf, top_boxes = detect()       # utils.py

    # Para cada candidato:
    for conf, box in zip(top_conf, top_boxes):
        # Conversiรณn pixelโDM
        dm_val = pixel_to_physical()     # astro_conversions.py

        # Dedispersiรณn del patch
        patch = dedisperse_patch()       # dedispersion.py

        # Clasificaciรณn
        class_prob = classify_patch()    # utils.py

        # Cรกlculo SNR
        snr_val = compute_snr()          # metrics.py / snr_utils.py

        # Guarda candidato
        append_candidate()               # candidate_utils.py
```

### **5. Visualizaciรณn**

```python
# Para cada slice con candidatos:
save_all_plots()                        # plot_manager.py
โโโ save_slice_summary()                # visualization.py
โ   โโโ save_detection_plot()           # image_utils.py
โ   โโโ plot_waterfall_block()          # image_utils.py
โ   โโโ save_patch_plot()               # visualization.py
โโโ save_plot()                         # visualization.py
```

## ๐ **Dependencias por Archivo**

### **Archivos Principales (Sin Dependencias Externas)**

- `config.py` - Configuraciรณn global
- `candidate.py` - Estructura de datos
- `__init__.py` - Inicializaciรณn del mรณdulo

### **Archivos de I/O**

- `io.py` โ `config.py`
- `filterbank_io.py` โ `config.py`
- `io_utils.py` โ `io.py`, `filterbank_io.py`
- `candidate_utils.py` โ `candidate.py`

### **Archivos de Procesamiento**

- `preprocessing.py` โ `config.py`
- `dedispersion.py` โ `config.py`
- `astro_conversions.py` โ `config.py`
- `dynamic_dm_range.py` โ `config.py`

### **Archivos de Detecciรณn**

- `utils.py` โ `config.py`
- `metrics.py` โ `config.py`
- `pipeline_utils.py` โ Mรบltiples mรณdulos
- `snr_utils.py` โ `config.py`

### **Archivos de Visualizaciรณn**

- `image_utils.py` โ `config.py`, `astro_conversions.py`, `snr_utils.py`
- `visualization.py` โ Mรบltiples mรณdulos
- `plot_manager.py` โ `visualization.py`, `image_utils.py`

### **Archivos de Gestiรณn**

- `auto_slice_len.py` โ `config.py`
- `slice_len_utils.py` โ `config.py`, `auto_slice_len.py`
- `summary_utils.py` โ `config.py`
- `consistency_fixes.py` โ `config.py`, `astro_conversions.py`, `snr_utils.py`

### **Archivo Principal**

- `pipeline.py` โ Todos los mรณdulos anteriores

## ๐ **Relaciones Crรญticas**

### **1. Flujo de Datos Principal**

```
pipeline.py โ pipeline_utils.py โ utils.py โ candidate_utils.py
     โ              โ              โ              โ
visualization.py โ image_utils.py โ plot_manager.py โ Resultados
```

### **2. Gestiรณn de Configuraciรณn**

```
config.py โ Todos los mรณdulos
     โ
auto_slice_len.py โ slice_len_utils.py
```

### **3. Procesamiento de SNR**

```
snr_utils.py โ metrics.py
     โ
consistency_fixes.py โ pipeline_utils.py
```

### **4. Visualizaciรณn**

```
visualization.py โ image_utils.py
     โ
plot_manager.py โ Todos los plots
```

## ๐ฏ **Puntos de Integraciรณn Clave**

### **1. Para el Gestor de Consistencia (`consistency_fixes.py`)**

- **Entrada**: `pipeline_utils.py` (lรญnea ~30 en `process_band()`)
- **Salida**: `visualization.py` (lรญnea ~243 en `save_slice_summary()`)
- **Beneficio**: Unificaciรณn de DM y SNR en todo el pipeline

### **2. Para Optimizaciones de Memoria**

- **Entrada**: `pipeline.py` (lรญnea ~44 en `_optimize_memory()`)
- **Salida**: Todos los mรณdulos de visualizaciรณn
- **Beneficio**: Gestiรณn eficiente de memoria en archivos grandes

### **3. Para SLICE_LEN Dinรกmico**

- **Entrada**: `auto_slice_len.py` โ `slice_len_utils.py`
- **Salida**: `pipeline_utils.py` (lรญnea ~30 en `get_pipeline_parameters()`)
- **Beneficio**: Optimizaciรณn automรกtica segรบn caracterรญsticas del archivo

## ๐ **Estadรญsticas del Pipeline**

- **Total de archivos**: 22 mรณdulos
- **Archivos principales**: 4 (pipeline, config, utils, visualization)
- **Archivos de I/O**: 4 (io, filterbank_io, io_utils, candidate_utils)
- **Archivos de procesamiento**: 4 (preprocessing, dedispersion, astro_conversions, dynamic_dm_range)
- **Archivos de detecciรณn**: 4 (utils, metrics, pipeline_utils, snr_utils)
- **Archivos de visualizaciรณn**: 3 (visualization, image_utils, plot_manager)
- **Archivos de gestiรณn**: 5 (auto_slice_len, slice_len_utils, summary_utils, consistency_fixes, candidate)
- **Archivos de configuraciรณn**: 2 (config, **init**)

## ๐ **Conclusiรณn**

El pipeline `drafts/` estรก **bien estructurado** con una **separaciรณn clara de responsabilidades**:

- โ **Modularidad**: Cada mรณdulo tiene una funciรณn especรญfica
- โ **Escalabilidad**: Fรกcil agregar nuevas funcionalidades
- โ **Mantenibilidad**: Cรณdigo organizado y documentado
- โ **Flexibilidad**: Configuraciรณn centralizada y dinรกmica

La integraciรณn del **gestor de consistencia** (`consistency_fixes.py`) resolverรก las discrepancias identificadas y mejorarรก la **confiabilidad** del pipeline.
